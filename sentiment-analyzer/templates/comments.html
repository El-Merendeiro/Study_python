<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>保存したコメント</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .chart-container { width: 100%; max-width: 700px; margin-bottom: 20px; }
    .list-item { margin-bottom: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .meta { font-size: 0.9em; color: #444; }
    a { display:inline-block; margin-top:12px; }
  </style>
</head>
<body>
  <h1>保存したコメント＆感情分析</h1>

  {% set comments_data = [] %}
  {% for i in range(comments_list|length) %}
    {% set _ = comments_data.append({
        'comment': comments_list[i] or "",
        'label': sentiment_label_list[i] or "N/A",
        'score': sentiment_score_list[i] or 0
    }) %}
  {% endfor %}

  {% if comments_data %}
  <div class="chart-container">
    <canvas id="sentimentChart" width="700" height="200"></canvas>
  </div>
  {% else %}
    <p>コメントがまだありません</p>
  {% endif %}

  <h2>保存したコメント一覧</h2>
  <div id="commentsArea">
    {% for c in comments_data %}
      <div class="list-item">
        <div><strong>コメント:</strong> {{ c.comment }}</div>
        <div class="meta">
          <strong>ラベル:</strong> {{ c.label }} &nbsp;|&nbsp;
          <strong>信頼度:</strong> {{ c.score | round(3) }}
        </div>
      </div>
    {% endfor %}
  </div>

  <a href="/">ホームに戻る</a>

  <script>
    const comments = {{ comments_data | tojson }};
    let positiveCount = 0;
    let negativeCount = 0;
    let neutralCount = 0;

    for (const c of comments) {
      const lab = (c.label || "").toUpperCase();
      if (lab === "POSITIVE" || lab === "POS") positiveCount++;
      else if (lab === "NEGATIVE" || lab === "NEG") negativeCount++;
      else neutralCount++;
    }

    if (comments.length > 0) {
      const ctx = document.getElementById('sentimentChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ポジティブ', 'ネガティブ', 'ニュートラル'],
          datasets: [{
            label: 'コメント数',
            data: [positiveCount, negativeCount, neutralCount],
            backgroundColor: [
              'rgba(75, 192, 192, 0.7)',
              'rgba(255, 99, 132, 0.7)',
              'rgba(201, 203, 207, 0.7)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          indexAxis: 'y',
          scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { enabled: true } }
        }
      });
    }
  </script>
</body>
</html>
