<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Commenti analizzati - iPhone 17</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Chart.js CDN (versione compatta) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .chart-container { width: 100%; max-width: 700px; margin-bottom: 20px; }
    .list-item { margin-bottom: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .meta { font-size: 0.9em; color: #444; }
    a { display:inline-block; margin-top:12px; }
  </style>
</head>
<body>
  <h1>Commenti salvati e sentiment</h1>

  {% if comments_list and sentiment_label_list %}
  <div class="chart-container">
    <canvas id="sentimentChart" width="700" height="200"></canvas>
  </div>
  {% else %}
    <p>Nessun commento salvato.</p>
  {% endif %}

  <h2>Elenco commenti</h2>
  <div id="commentsArea">
    {% if comments_list %}
      {% for i in range(comments_list|length) %}
        <div class="list-item">
          <div><strong>Commento:</strong> {{ comments_list[i] }}</div>
          <div class="meta">
            <strong>Sentiment:</strong> {{ sentiment_label_list[i] }} &nbsp;|&nbsp;
            <strong>Score:</strong> {{ (sentiment_score_list[i] if sentiment_score_list[i] is not none else 0)|round(3) }}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <a href="/">â—€ Torna alla home</a>

  <script>
    // Costruisco l'array JS dai tre array passati dal server (sicuro usando tojson per ogni elemento)
    const comments = [];
    {% for i in range(comments_list|length) %}
    comments.push({
      comment: {{ comments_list[i] | tojson }},
      label:   {{ sentiment_label_list[i] | tojson }},
      score:   {{ sentiment_score_list[i] | default(0) | tojson }}
    });
    {% endfor %}

    // Calcolo contatori
    let positiveCount = 0;
    let negativeCount = 0;
    let neutralCount = 0;
    for (const c of comments) {
      const lab = (c.label || "").toString().toUpperCase();
      if (lab === "POSITIVE" || lab === "POS") positiveCount++;
      else if (lab === "NEGATIVE" || lab === "NEG") negativeCount++;
      else neutralCount++;
    }

    // Se non ci sono commenti, non disegno il grafico
    if (comments.length > 0) {
      const ctx = document.getElementById('sentimentChart').getContext('2d');

      // Grafico a barre orizzontali (indexAxis: 'y')
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Positive', 'Negative', 'Neutral'],
          datasets: [{
            label: 'Numero commenti',
            data: [positiveCount, negativeCount, neutralCount],
            // colori minimi per chiarezza
            backgroundColor: [
              'rgba(75, 192, 192, 0.7)',
              'rgba(255, 99, 132, 0.7)',
              'rgba(201, 203, 207, 0.7)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          indexAxis: 'y', // rende le barre orizzontali
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } }
          },
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }
  </script>
</body>
</html>
